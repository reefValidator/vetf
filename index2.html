<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VETF — Preis in CRO & USD</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0f1724;
      --card: #0f1724;
      --glass: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      --accent: #7c3aed; /* violett */
      --success: #10b981;
      --danger: #ef4444;
      --glass-border: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg,#071029 0%, #071a2a 100%);
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e6eef7;
      padding:24px;
    }
    .wrap{
      width:100%;
      max-width:820px;
    }
    header{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:18px;
    }
    .logo{
      width:56px; height:56px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(124,58,237,0.12), rgba(16,185,129,0.06));
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border:1px solid var(--glass-border);
      font-weight:700;
      color:var(--accent);
    }
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:18px;
      border:1px solid var(--glass-border);
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:16px;
    }

    .price-box{
      padding:18px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));
      border:1px solid rgba(255,255,255,0.03);
    }
    .price-label{font-size:13px;color:var(--muted)}
    .price-value{font-size:28px;font-weight:600;margin-top:8px}
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
      gap:10px;
    }
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;align-items:center}
    button{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      padding:8px 12px;
      border-radius:10px;
      color:inherit;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    button.primary{
      background: linear-gradient(90deg,var(--accent), #06b6d4);
      border: none;
      color: white;
      box-shadow: 0 6px 20px rgba(124,58,237,0.12);
    }
    .status{font-size:13px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .error{color:var(--danger);font-weight:600}
    .ok{color:var(--success);font-weight:600}
    footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:right}

    /* responsive */
    @media (max-width:640px){
      .grid{grid-template-columns: 1fr}
      header{gap:10px}
      .logo{width:48px;height:48px}
      .price-value{font-size:22px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">VETF</div>
      <div>
        <h1>VETF — Preis in CRO &amp; USD</h1>
        <p class="lead">Hol dir die Werte aus einer JSON-Datei (alle 30 Minuten aktualisiert).</p>
      </div>
    </header>

    <div class="card" id="mainCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div class="muted">Aktueller Preis</div>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:baseline">
            <div style="font-size:18px;font-weight:700">VETF</div>
            <div id="marketStatus" class="small muted">— lade...</div>
          </div>
        </div>

        <div class="controls">
          <button id="refreshBtn" title="Manuell aktualisieren">↻ Aktualisieren</button>
          <button id="settingsBtn" title="Konfiguration">⚙</button>
        </div>
      </div>

      <div class="grid">
        <div class="price-box">
          <div class="price-label">Preis (CRO)</div>
          <div id="priceCRO" class="price-value">—</div>
          <div class="meta">
            <div class="muted">Quelle: <span id="sourceInfo">JSON</span></div>
            <div id="croChange" class="small muted"></div>
          </div>
        </div>

        <div class="price-box">
          <div class="price-label">Preis (USD)</div>
          <div id="priceUSD" class="price-value">—</div>
          <div class="meta">
            <div class="muted">Stand: <span id="lastUpdated">—</span></div>
            <div id="usdChange" class="small muted"></div>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:12px">
        <div id="statusText" class="status">Warte auf Daten…</div>
        <div class="small muted">Automatische Aktualisierung: 30 Minuten</div>
      </div>

      <footer>
        Konfiguriere die JSON-Quelle und -Felder im Skriptkopf der Seite.
      </footer>
    </div>
  </div>

  <script>
    /*****************************************************************
     * Konfiguration (anpassen)
     *
     * JSON_URL: Pfad/URL zur JSON-Datei (z. B. "/data/prices.json" oder
     *           "https://yourserver.com/prices.json").
     *
     * USD_PATH / CRO_PATH: Punkt-getrennte Pfade innerhalb der JSON-Datei,
     *                      z. B. "vetf.usd" oder "data.tokens.vetf.price_usd".
     *
     * Falls die JSON bereits ein timestamp-Feld enthält (z. B. "updated_at"),
     * kannst du UPDATE_TIMESTAMP_PATH setzen; ansonsten verwendet die Seite
     * die lokale Empfangszeit.
     *****************************************************************/
    const JSON_URL = '/price.json'; // <-- HIER die URL zur JSON eintragen
    const USD_PATH = 'vetf_usd';     // Versuche diese Pfade anzupassen
    const CRO_PATH = 'vetf_cro';
    const UPDATE_TIMESTAMP_PATH = 'updated'; // optional, null wenn nicht vorhanden

    // Aktualisierungsintervalle
    const REFRESH_INTERVAL_MS = 30 * 60 * 1000; // 30 Minuten (Standard)
    const RETRY_ON_FAIL_MS = 60 * 1000; // 1 Minute Retry bei Fehler

    // --- Hilfsfunktionen ---
    function getByPath(obj, path) {
      if (!path) return undefined;
      const parts = path.split('.');
      let cur = obj;
      for (const p of parts) {
        if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
        else return undefined;
      }
      return cur;
    }

    function formatUSD(value) {
      if (value == null || isNaN(value)) return '—';
      try {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 6 }).format(value);
      } catch (e) {
        return (Number(value)).toFixed(6) + ' USD';
      }
    }
    function formatCRO(value) {
      if (value == null || isNaN(value)) return '—';
      // CRO isn't a standard Intl currency in all environments — show as number + " CRO"
      const formatted = new Intl.NumberFormat(undefined, { maximumFractionDigits: 6 }).format(value);
      return formatted + ' CRO';
    }

    // DOM refs
    const elPriceUSD = document.getElementById('priceUSD');
    const elPriceCRO = document.getElementById('priceCRO');
    const elLastUpdated = document.getElementById('lastUpdated');
    const elStatus = document.getElementById('statusText');
    const elSource = document.getElementById('sourceInfo');
    const elMarketStatus = document.getElementById('marketStatus');
    const refreshBtn = document.getElementById('refreshBtn');

    let lastValues = { usd: null, cro: null };
    let timerId = null;

    async function fetchPrices(isManual=false) {
      elStatus.textContent = isManual ? 'Manuelle Aktualisierung…' : 'Lade Daten…';
      elMarketStatus.textContent = 'lade...';
      try {
        const resp = await fetch(JSON_URL, { cache: 'no-store' });
        if (!resp.ok) throw new Error('Netzwerkfehler: ' + resp.status);
        const data = await resp.json();

        // Versuche verschiedene Pfade (konfiguriert oben)
        let usd = getByPath(data, USD_PATH);
        let cro = getByPath(data, CRO_PATH);
        let ts = getByPath(data, UPDATE_TIMESTAMP_PATH);

        // Falls Pfade nicht passen: Suche heuristisch nach üblichen Feldern
        if ((usd === undefined || usd === null) && data?.vetf) {
          usd = data.vetf.usd ?? data.vetf.price_usd ?? data.vetf.priceUSD;
        }
        if ((cro === undefined || cro === null) && data?.vetf) {
          cro = data.vetf.cro ?? data.vetf.price_cro ?? data.vetf.priceCRO;
        }
        // Wenn noch nichts gefunden, scanne flach
        if ((usd === undefined || usd === null) || (cro === undefined || cro === null)) {
          // Suche im obersten Objekt nach numeric Werte mit 'usd' bzw 'cro' in Schlüssel
          for (const k of Object.keys(data)) {
            const v = data[k];
            if ((usd === undefined || usd === null) && /usd/i.test(k) && typeof v === 'number') usd = v;
            if ((cro === undefined || cro === null) && /cro/i.test(k) && typeof v === 'number') cro = v;
          }
        }

        // Update UI
        elPriceUSD.textContent = formatUSD(Number(usd));
        elPriceCRO.textContent = formatCRO(Number(cro));

        // Changes / small delta indicator (optional)
        updateDeltas(Number(usd), Number(cro));

        // Timestamp
        if (ts) {
          // versuche gängige Timestamp-Formate
          const dt = new Date(ts);
          if (!isNaN(dt)) {
            elLastUpdated.textContent = dt.toLocaleString();
          } else {
            elLastUpdated.textContent = String(ts);
          }
        } else {
          elLastUpdated.textContent = (new Date()).toLocaleString();
        }

        elStatus.innerHTML = '<span class="ok">Daten geladen</span>';
        elSource.textContent = JSON_URL;
        elMarketStatus.textContent = 'aktuell';

        // Save last values
        lastValues = { usd: Number(usd), cro: Number(cro) };

        // Plan next fetch in REFRESH_INTERVAL_MS
        scheduleNextFetch(REFRESH_INTERVAL_MS);

      } catch (err) {
        console.error('Fehler beim Laden der Preise:', err);
        elStatus.innerHTML = '<span class="error">Fehler beim Laden — Konsole prüfen</span>';
        elMarketStatus.textContent = 'fehler';
        scheduleNextFetch(RETRY_ON_FAIL_MS);
      }
    }

    function scheduleNextFetch(ms) {
      if (timerId) clearTimeout(timerId);
      timerId = setTimeout(() => fetchPrices(false), ms);
    }

    function updateDeltas(usd, cro) {
      const elUsdChange = document.getElementById('usdChange');
      const elCroChange = document.getElementById('croChange');

      function deltaHtml(newVal, oldVal) {
        if (oldVal == null || isNaN(oldVal) || newVal == null || isNaN(newVal)) return '';
        const d = newVal - oldVal;
        const sign = d > 0 ? '+' : (d < 0 ? '−' : '');
        const short = (Math.abs(d) >= 0.01) ? Math.abs(d).toFixed(6) : Math.abs(d).toExponential(2);
        const cls = d > 0 ? 'ok' : (d < 0 ? 'error' : '');
        return `<span class="${cls}">${sign}${short}</span>`;
      }

      elUsdChange.innerHTML = deltaHtml(usd, lastValues.usd);
      elCroChange.innerHTML = deltaHtml(cro, lastValues.cro);
    }

    // Button
    refreshBtn.addEventListener('click', () => fetchPrices(true));

    // Minimal "settings" dialog via prompt (so wir single-file bleiben)
    document.getElementById('settingsBtn').addEventListener('click', () => {
      const u = prompt('JSON-URL (aktuell: ' + JSON_URL + ')', JSON_URL);
      if (u) {
        // Hinweis: Die Seite muss neu geladen werden, damit die Konstante geändert wird.
        alert('Hinweis: Um die URL dauerhaft zu ändern, öffne die HTML-Datei und passe die Konstante JSON_URL an.\n\nFür einen schnellen Test verwende die eingegebene URL in der Konsole oder lade die Datei lokal neu.');
      }
    });

    // Erstaufruf
    fetchPrices(false);

    // Falls der Benutzer die Seite offen hält, erneuern wir beim Sichtbarwerden der Seite (focus/tab)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        fetchPrices(false);
      }
    });
  </script>
</body>
</html>
